<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Панель Управления</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <link rel="stylesheet" href="https://unpkg.com/@primer/css/dist/primer.css">

  <style>
    * {
       box-sizing: border-box;
   }

   body {
       margin: 0;
       font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
       background-color: #f0f2f5; /* Светло-серый фон */
       color: #24292e;
   }

   #wrapper {
       display: flex;
   }

         .navbar-icons a:hover {
            color: #d39e00;
        }

        .navbar-icons form button .fas {
            font-size: 24px;
            color: #dc3545;
            transition: color 0.3s;
        }



   /* Sidebar */
   #sidebar-wrapper {
       width: 60px;
       height: 100vh;
       background-color: #ffffff; /* Белый фон меню */
       border-right: none; /* Убираем разделительную линию */
       transition: width 0.3s ease;
       position: fixed;
       display: flex;
       flex-direction: column;
       align-items: center;
       padding-top: 20px;
   }

   #sidebar-wrapper.expanded {
       width: 250px;
       align-items: flex-start;
       padding-left: 20px;
   }

   .sidebar-heading {
       text-align: center;
       margin-bottom: 30px;
   }

   .sidebar-heading i {
       font-size: 24px;
       color: #6f42c1; /* Фиолетовый цвет */
   }

   .sidebar-heading .sidebar-text {
       margin-left: 10px;
       font-size: 18px;
       color: #6f42c1;
       display: none;
   }

   #sidebar-wrapper.expanded .sidebar-text {
       display: inline;
   }

   .list-group-item {
       padding: 15px 20px;
       text-decoration: none;
       color: #6c757d;
       display: flex;
       align-items: center;
       transition: background 0.3s, color 0.3s;
       border: none; /* Убираем разделительную линию */
       border-radius: 8px;
       margin: 5px 10px;
       width: 100%;
       position: relative;
   }

   .list-group-item:hover {
       background-color: #e6e6e6;
       color: #6f42c1;
   }

   .list-group-item.active {
       background-color: #6f42c1;
       color: #ffffff;
       border: 1px solid #6f42c1;
   }

   .list-group-item i {
       margin-right: 10px;
       font-size: 18px;
       min-width: 20px;
       text-align: center;
   }

   #sidebar-wrapper .list-group-item {
       text-decoration: none;
   }


   #page-content-wrapper {
       margin-left: 60px;
       flex-grow: 1;
       transition: margin-left 0.2s ease;
   }

   #sidebar-wrapper.expanded + #page-content-wrapper {
       margin-left: 200px;
   }
    .navbar {
        display: flex;
        justify-content: center; /* Центрирование содержимого */
        align-items: center;
        padding: 10px 20px;
        background-color: #f0f2f5;
        border-bottom: none;
        box-shadow: none;
    }
    .navbar-icons {
        display: flex;
        align-items: center;
        gap: 15px; /* Расстояние между элементами */
    }

    .admin-info {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-right: auto; /* Перемещает элементы вправо */
    }

    .admin-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;

    }

    .admin-name {
        font-size: 16px;
        font-weight: 600;
        color: #24292e;
    }

    .navbar-icons a,
    .navbar-icons form button {
        font-size: 24px;
        cursor: pointer;
        transition: color 0.3s;
    }

    .navbar-icons a:hover,
    .navbar-icons form button:hover {
        color: #d39e00;
    }
     .navbar-icons form button .fas:hover {
                color: #bd2130;
            }
   .navbar button {
       padding: 8px;
       background-color: #6c757d;
       border: none;
       color: #fff;
       cursor: pointer;
   }

   .navbar button:hover {
       background-color: #5a6268;
   }
/* Статистические карточки */
.stats-row {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background-color: #ffffff;
    border: 1px solid #dcdcdc;
    border-radius: 12px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    padding: 20px;
    flex: 1 1 200px; /* Гибкая ширина для адаптивности */
    display: flex;
    flex-direction: column;
    align-items: center;
    transition: transform 0.3s, box-shadow 0.3s;
    position: relative;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}

.stat-card i {
    font-size: 36px;
    color: #6f42c1;
    margin-bottom: 15px;
}

.stat-card h5 {
    margin: 0 0 10px;
    font-size: 18px;
    color: #6c757d;
    text-align: center;
}

.stat-card h3 {
    margin: 0;
    font-size: 28px;
    font-weight: bold;
    text-align: center;
}

/* Маленькие карточки */
.small-card {
    display: flex;
    align-items: center;
    background-color: #ffffff;
    border: 1px solid #dcdcdc;
    border-radius: 12px;
    padding: 10px 15px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s, box-shadow 0.3s;
    flex: 1 1 150px; /* Гибкая ширина для адаптивности */
    flex-direction: column;
    text-align: center;
}

.small-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.small-card i {
    font-size: 24px;
    color: #6f42c1;
    margin-bottom: 10px;
}

.small-card h3 {
    margin: 0;
    font-size: 22px;
    font-weight: bold;
    color: #24292e;
}

.small-card span {
    font-size: 14px;
    color: #6c757d;
    margin-top: 5px;
}

/* Графики */
.chart-card {
    background-color: #ffffff;
    border-radius: 12px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 20px;
    flex: 1 1 300px;
}

.chart-card h5 {
    margin-bottom: 15px;
    font-size: 18px;
    color: #6c757d;
    text-align: center;
}

/* Компактное расположение */
.container-fluid {
    padding: 0 20px;
}

@media (max-width: 768px) {
    .stat-card, .small-card, .chart-card {
        flex: 1 1 100%;
    }
}
  </style>
</head>
<body>
<div id="wrapper">
  <!-- Sidebar -->
  <div id="sidebar-wrapper">
    <div class="sidebar-heading">
      <i class="fas fa-chart-line"></i> <span class="sidebar-text"></span>
    </div>
    <a href="/admin/dashboard" class="list-group-item active">
      <i class="fas fa-home"></i> <span class="sidebar-text"></span>
    </a>
    <a href="/admin/users" class="list-group-item">
      <i class="fas fa-users"></i> <span class="sidebar-text"></span>
    </a>
    <a href="/admin/projects" class="list-group-item">
      <i class="fas fa-folder-open"></i> <span class="sidebar-text"></span>
    </a>
    <a href="/admin/unbanRequests" class="list-group-item">
      <i class="fas fa-ban"></i> <span class="sidebar-text"> </span>
    </a>
  </div>

  <!-- Page content -->
  <div id="page-content-wrapper">
    <!-- Navbar -->
    <div class="navbar">
      <div class="admin-info">
        <img th:src="${client.avatarUrl != null ? client.avatarUrl : '/noAvatar.png'}" alt="User Avatar" class="admin-avatar">
        <span class="admin-name" th:text="${client.username}"></span>
      </div>
      <div class="navbar-icons">
        <a href="/admin/notifications" title="Уведомления">
          <i class="fas fa-bell"></i>
        </a>
        <form th:action="@{/logout}" th:method="POST">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
          <button type="submit" title="Выход" style="background: none; border: none; padding: 0;">
            <i class="fas fa-sign-out-alt"></i>
          </button>
        </form>
      </div>
    </div>

    <!-- Main Content -->
    <div class="container-fluid">
      <!-- Статистические карточки -->
      <div class="stats-row">
        <div class="stat-card">
          <i class="fas fa-project-diagram"></i>
          <h5>Всего проектов</h5>
          <h3 th:text="${totalProjects}">0</h3>
          <canvas id="totalProjectsChart" height="100"></canvas>
        </div>
        <div class="stat-card">
          <i class="fas fa-users"></i>
          <h5>Всего пользователей</h5>
          <h3 th:text="${totalUsers}">0</h3>
          <canvas id="totalUsersChart" height="100"></canvas>
        </div>
        <div class="stat-card">
          <i class="fas fa-user-lock"></i>
          <h5>Заблокированные пользователи</h5>
          <h3 th:text="${bannedUsers}">0</h3>
        </div>
        <div class="stat-card">
          <i class="fas fa-clock"></i>
          <h5>Общее время онлайн</h5>
          <h3 id="onlineTime" th:text="${totalOnlineTime}">00h:00m:00s</h3>
        </div>
      </div>

      <!-- Маленькие карточки для новых проектов и пользователей -->
      <div class="stats-row">
        <div class="small-card">
          <i class="fas fa-calendar-day"></i>
          <h3 th:text="${newProjectsToday}">0</h3>
          <span>Новых проектов сегодня</span>
        </div>
        <div class="small-card">
          <i class="fas fa-calendar-week"></i>
          <h3 th:text="${newProjectsThisWeek}">0</h3>
          <span>Новых проектов за неделю</span>
        </div>
        <div class="small-card">
          <i class="fas fa-calendar-alt"></i>
          <h3 th:text="${newProjectsThisMonth}">0</h3>
          <span>Новых проектов за месяц</span>
        </div>
        <div class="small-card">
          <i class="fas fa-user-plus"></i>
          <h3 th:text="${newUsersLastDay}">0</h3>
          <span>Новых пользователей сегодня</span>
        </div>
        <div class="small-card">
          <i class="fas fa-user-clock"></i>
          <h3 th:text="${newUsersLastWeek}">0</h3>
          <span>Новых пользователей за неделю</span>
        </div>
        <div class="small-card">
          <i class="fas fa-user-friends"></i>
          <h3 th:text="${newUsersLastMonth}">0</h3>
          <span>Новых пользователей за месяц</span>
        </div>
      </div>

      <!-- Активные пользователи -->
      <div class="stats-row">
        <div class="small-card">
          <i class="fas fa-user-clock"></i>
          <h3 th:text="${activeUsersLastDay}">0</h3>
          <span>Активных пользователей сегодня</span>
        </div>
        <div class="small-card">
          <i class="fas fa-user-clock"></i>
          <h3 th:text="${activeUsersLastWeek}">0</h3>
          <span>Активных пользователей за неделю</span>
        </div>
        <div class="small-card">
          <i class="fas fa-user-clock"></i>
          <h3 th:text="${activeUsersLastMonth}">0</h3>
          <span>Активных пользователей за месяц</span>
        </div>
      </div>

      <!-- Топ пользователей -->
      <div class="chart-card">
        <h5>Топ пользователей по времени онлайн</h5>
        <ul>
          <li th:each="entry : ${topUsers}" style="display: flex; justify-content: space-between; width: 100%; padding: 5px 0;">
            <span th:text="${entry.key.username}">Username</span>
            <span th:text="${#numbers.formatDecimal(entry.value / 3600, 1, 'POINT', 'COMMA')} + ' ч'">0 ч</span>
          </li>
        </ul>
      </div>

      <!-- Графики -->
      <div class="stats-row">
        <div class="chart-card">
          <h5>Активные пользователи</h5>
          <canvas id="usersChart" height="100"></canvas>
        </div>
        <div class="chart-card">
          <h5>Активные проекты</h5>
          <canvas id="projectsChart" height="100"></canvas>
        </div>
        <div class="chart-card">
          <h5>Распределение проектов по языкам</h5>
          <canvas id="languageChart" height="100"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Скрипты -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script th:inline="javascript">
      /*<![CDATA[*/
      document.addEventListener("DOMContentLoaded", function () {
          // Данные для графиков из модели (данные можно передавать из контроллера как JSON)
          const labels = /*[[${activityLabels}]]*/ []; // Метки оси X, такие как даты
          const totalProjectsData = /*[[${activityProjectCounts}]]*/ []; // Количество проектов за период
          const totalUsersData = /*[[${activityUserCounts}]]*/ []; // Количество пользователей за период

          // График "Всего проектов"
          if (labels.length > 0 && totalProjectsData.length > 0) {
              const totalProjectsCtx = document.getElementById('totalProjectsChart').getContext('2d');
              new Chart(totalProjectsCtx, {
                  type: 'line',
                  data: {
                      labels: labels,
                      datasets: [{
                          label: 'Проекты',
                          data: totalProjectsData,
                          fill: false,
                          borderColor: 'rgba(54, 162, 235, 1)',
                          backgroundColor: 'rgba(54, 162, 235, 0.2)',
                          tension: 0.4,
                          pointRadius: 0,
                          pointHoverRadius: 7,
                          borderWidth: 2
                      }]
                  },
                  options: {
                      plugins: {
                          legend: { display: false },
                          tooltip: {
                              enabled: true,
                              callbacks: {
                                  label: function(context) {
                                      return `Количество: ${context.parsed.y}`;
                                  }
                              }
                          }
                      },
                      scales: {
                          x: { display: false },
                          y: { display: false }
                      }
                  }
              });
          }

          // График "Всего пользователей"
          if (labels.length > 0 && totalUsersData.length > 0) {
              const totalUsersCtx = document.getElementById('totalUsersChart').getContext('2d');
              new Chart(totalUsersCtx, {
                  type: 'line',
                  data: {
                      labels: labels,
                      datasets: [{
                          label: 'Пользователи',
                          data: totalUsersData,
                          fill: false,
                          borderColor: 'rgba(75, 192, 192, 1)',
                          backgroundColor: 'rgba(75, 192, 192, 0.2)',
                          tension: 0.4,
                          pointRadius: 0,
                          pointHoverRadius: 7,
                          borderWidth: 2
                      }]
                  },
                  options: {
                      plugins: {
                          legend: { display: false },
                          tooltip: {
                              enabled: true,
                              callbacks: {
                                  label: function(context) {
                                      return `Количество: ${context.parsed.y}`;
                                  }
                              }
                          }
                      },
                      scales: {
                          x: { display: false },
                          y: { display: false }
                      }
                  }
              });
          }
      });
      /*]]>*/
</script>

<script th:inline="javascript">
  /*<![CDATA[*/
  function updateOnlineTime() {
      fetch('/admin/totalOnlineTime')
          .then(response => {
              if (!response.ok) {
                  throw new Error('Network response was not ok ' + response.statusText);
              }
              return response.text();
          })
          .then(data => {
              document.getElementById('onlineTime').innerText = data;
          })
          .catch(error => console.error('Error fetching online time:', error));
  }

  // Обновлять время каждые 10 секунд
  setInterval(updateOnlineTime, 10000);

  // Первый вызов при загрузке страницы
  updateOnlineTime();
  /*]]>*/
</script>

<script th:inline="javascript">
  /*<![CDATA[*/
  const languageLabels = [[${projectLanguageLabels}]]; // Языки
  const languageCounts = [[${projectLanguageCounts}]]; // Количество проектов

  const languageCtx = document.getElementById('languageChart').getContext('2d');
  new Chart(languageCtx, {
      type: 'pie',
      data: {
          labels: languageLabels,
          datasets: [{
              label: 'Проекты',
              data: languageCounts,
              backgroundColor: [
                  'rgba(255, 99, 132, 0.2)',
                  'rgba(54, 162, 235, 0.2)',
                  'rgba(255, 206, 86, 0.2)',
                  'rgba(75, 192, 192, 0.2)',
                  'rgba(153, 102, 255, 0.2)',
                  'rgba(255, 159, 64, 0.2)'
              ],
              borderColor: [
                  'rgba(255, 99, 132, 1)',
                  'rgba(54, 162, 235, 1)',
                  'rgba(255, 206, 86, 1)',
                  'rgba(75, 192, 192, 1)',
                  'rgba(153, 102, 255, 1)',
                  'rgba(255, 159, 64, 1)'
              ],
              borderWidth: 1
          }]
      },
      options: {
          responsive: true,
          plugins: {
              legend: {
                  position: 'top',
              },
              tooltip: { enabled: true }
          }
      }
  });
  /*]]>*/
</script>

<script th:inline="javascript">
  /*<![CDATA[*/
  function updateStats() {
      fetch('/admin/users') // Эндпоинт для получения свежих данных
          .then(response => response.json())
          .then(data => {
              document.querySelector('h3[th\\:text="${totalProjects}"]').innerText = data.totalProjects;
              document.querySelector('h3[th\\:text="${newProjectsToday}"]').innerText = data.newProjectsToday;
              document.querySelector('h3[th\\:text="${newProjectsThisWeek}"]').innerText = data.newProjectsThisWeek;
              document.querySelector('h3[th\\:text="${newProjectsThisMonth}"]').innerText = data.newProjectsThisMonth;
              // Обновить таблицы или графики, если нужно
          })
          .catch(error => console.error('Ошибка обновления статистики:', error));
  }

  setInterval(updateStats, 30000); // Обновлять каждые 30 секунд
  /*]]>*/
</script>
</body>
</html>
