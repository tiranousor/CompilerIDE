<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Панель Управления</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <link rel="stylesheet" href="https://unpkg.com/@primer/css/dist/primer.css">

  <!-- CSRF Tokens -->
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

  <style>
    /* Общие стили */
    * {
        box-sizing: border-box;
    }

    body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
        background-color: #f0f0f0; /* Светло-серый фон */
        color: #24292e;
    }

    #wrapper {
        display: flex;
    }

    /* Sidebar */
    #sidebar-wrapper {
        width: 60px;
        height: 100vh;
        background-color: #ffffff; /* Белый фон меню */
        border-right: 1px solid #e3e6f0;
        transition: width 0.2s ease;
        position: fixed;
    }

    #sidebar-wrapper.expanded {
        width: 200px;
    }

    .sidebar-heading {
        text-align: center;
        padding: 20px 0;
        border-bottom: 1px solid #e3e6f0;
    }

    .sidebar-heading i {
        font-size: 24px;
        color: #6f42c1; /* Фиолетовый цвет */
    }

    .list-group-item {
        padding: 15px 20px;
        text-decoration: none;
        color: #6c757d;
        display: flex;
        align-items: center;
        transition: background 0.3s, color 0.3s;
        border: none; /* Убираем разделительную линию */
        border-radius: 8px;
        margin: 5px 10px;
    }

    .list-group-item:hover {
        background-color: #e6e6e6;
        color: #6f42c1;
    }

    .list-group-item.active {
        background-color: #6f42c1;
        color: #ffffff;
        border: 1px solid #6f42c1;
    }

    .list-group-item i {
        margin-right: 10px;
        font-size: 18px;
    }

    .sidebar-text {
        display: none;
    }

    #sidebar-wrapper.expanded .sidebar-text {
        display: inline;
    }

    /* Page Content */
    #page-content-wrapper {
        margin-left: 60px;
        flex-grow: 1;
        transition: margin-left 0.2s ease;
    }

    #sidebar-wrapper.expanded + #page-content-wrapper {
        margin-left: 200px;
    }

    /* Navbar */
    .navbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 30px;
        background-color: #f0f0f0; /* Светло-серый фон для хедера */
        /* border-bottom: none; */ /* Убираем нижнюю линию */
        box-shadow: none;
    }

    .navbar-icons a {
        color: #6c757d;
        margin-right: 15px;
        transition: color 0.3s;
        position: relative;
    }

    .navbar-icons a:hover {
        color: #6f42c1;
    }

    .navbar-icons a.active {
        color: #6f42c1;
        border: 1px solid #6f42c1;
        border-radius: 8px;
        padding: 5px;
    }

    .navbar-icons form button {
        color: #dc3545;
    }

    .navbar-icons form button:hover {
        color: #c82333;
    }

    /* Контент */
    .container-fluid {
        padding: 20px 30px;
    }

    .card {
        background-color: #ffffff;
        border: none;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }

    .card-body {
        padding: 20px;
    }

    .card-title {
        margin-bottom: 15px;
        font-size: 18px;
        color: #6f42c1;
    }

    .card h3 {
        font-size: 24px;
        color: #24292e;
    }

    /* Графики */
    .chart-container {
        position: relative;
        height: 400px;
        width: 100%;
    }

    /* Активная ссылка в меню */
    .list-group-item.active i {
        color: #ffffff;
    }

    /* Топ пользователей */
    .top-users-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .top-users-list li {
        display: flex;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #e3e6f0;
    }

    .top-users-list li:last-child {
        border-bottom: none;
    }

    .top-users-list .medal-icon {
        margin-right: 10px;
        font-size: 20px;
    }

    .gold-icon {
        color: gold;
    }

    .silver-icon {
        color: silver;
    }

    .bronze-icon {
        color: #cd7f32;
    }

    /* Responsive */
    @media (max-width: 768px) {
        #sidebar-wrapper.expanded {
            width: 60px;
        }

        #sidebar-wrapper.expanded .sidebar-text {
            display: none;
        }

        #sidebar-wrapper.expanded + #page-content-wrapper {
            margin-left: 60px;
        }
    }
  </style>
</head>
<body>
<div id="wrapper">
  <!-- Sidebar -->
  <div id="sidebar-wrapper">
    <div class="sidebar-heading">
      <i class="fas fa-chart-line"></i> <span class="sidebar-text">Admin Panel</span>
    </div>
    <a href="/admin/dashboard" class="list-group-item" th:classappend="${#request.requestURI == '/admin/dashboard'} ? 'active'">
      <i class="fas fa-home"></i> <span class="sidebar-text">Dashboard</span>
    </a>
    <a href="/admin/users" class="list-group-item" th:classappend="${#request.requestURI.startsWith('/admin/users')} ? 'active'">
      <i class="fas fa-users"></i> <span class="sidebar-text">Users</span>
    </a>
    <a href="/admin/projects" class="list-group-item" th:classappend="${#request.requestURI.startsWith('/admin/projects')} ? 'active'">
      <i class="fas fa-folder-open"></i> <span class="sidebar-text">Projects</span>
    </a>
    <a href="/admin/unbanRequests" class="list-group-item" th:classappend="${#request.requestURI.startsWith('/admin/unbanRequests')} ? 'active'">
      <i class="fas fa-ban"></i> <span class="sidebar-text">Unban Requests</span>
    </a>
  </div>

  <!-- Page content -->
  <div id="page-content-wrapper">
    <!-- Navbar -->
    <div class="navbar">
      <form class="search-bar" th:action="@{/admin/users}" method="get">
        <input type="text" class="search-input" name="query" placeholder="Поиск пользователей или проектов">
        <button type="submit" class="search-button"><i class="fas fa-search"></i></button>
      </form>
      <div class="navbar-icons">
        <a href="/admin/notifications" th:classappend="${#request.requestURI == '/admin/notifications'} ? 'active'">
          <i class="fas fa-bell"></i>
        </a>
        <form th:action="@{/logout}" th:method="POST" style="display: inline;">
          <button type="submit" style="background: none; border: none; cursor: pointer;">
            <i class="fas fa-sign-out-alt"></i>
          </button>
        </form>
      </div>
    </div>

    <!-- Content -->
    <div class="container-fluid">
      <div class="row">
        <!-- Общие показатели -->
        <div class="col-md-6 mb-4">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Всего проектов</h5>
              <h3 th:text="${totalProjects}">0</h3>
            </div>
          </div>
        </div>

        <div class="col-md-6 mb-4">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Всего пользователей</h5>
              <h3 th:text="${totalUsers}">0</h3>
            </div>
          </div>
        </div>
      </div>

      <!-- Графики -->
      <div class="row">
        <div class="col-md-6 mb-4">
          <div class="card chart-container">
            <div class="card-body">
              <h5 class="card-title">Активные пользователи</h5>
              <canvas id="usersChart"></canvas>
            </div>
          </div>
        </div>

        <div class="col-md-6 mb-4">
          <div class="card chart-container">
            <div class="card-body">
              <h5 class="card-title">Активные проекты</h5>
              <canvas id="projectsChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Топ пользователей по времени онлайн -->
      <div class="row">
        <div class="col-md-12 mb-4">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Топ пользователей по времени онлайн</h5>
              <ul class="top-users-list">
                <li th:each="entry, iterStat : ${topUsers}">
                  <i th:class="${iterStat.index == 0} ? 'fas fa-medal gold-icon' : (${iterStat.index == 1} ? 'fas fa-medal silver-icon' : 'fas fa-medal bronze-icon')"></i>
                  <span th:text="${entry.key.username}"></span>
                  <span th:text="${#numbers.formatDecimal(entry.value / 3600, 0, 'POINT')} + 'ч ' + (#numbers.formatDecimal((entry.value % 3600) / 60, 0, 'POINT')) + 'м'"></span>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- График распределения браузеров пользователей -->
      <div class="row">
        <div class="col-md-12 mb-4">
          <div class="card chart-container">
            <div class="card-body">
              <h5 class="card-title">Распределение пользователей по браузерам</h5>
              <canvas id="browserChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Скрипты -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script th:inline="javascript">
  /*<![CDATA[*/
  // Данные для графиков из модели
  const userLabels = [[${labels}]];
  const userData = [[${userData}]];
  const projectLabels = [[${projectLabels}]];
  const projectData = [[${projectData}]];
  const browserLabels = [[${browserLabels}]];
  const browserData = [[${browserData}]];

  // Настройка графика пользователей
  const usersCtx = document.getElementById('usersChart').getContext('2d');
  new Chart(usersCtx, {
      type: 'line',
      data: {
          labels: userLabels,
          datasets: [{
              label: 'Пользователи',
              data: userData,
              fill: true,
              borderColor: '#6f42c1',
              backgroundColor: 'rgba(111, 66, 193, 0.2)',
              tension: 0.4,
              pointRadius: 5,
              pointHoverRadius: 7,
          }]
      },
      options: {
          plugins: {
              legend: { display: false },
              tooltip: {
                  callbacks: {
                      label: function(context) {
                          return `Пользователи: ${context.parsed.y}`;
                      }
                  }
              }
          },
          scales: {
              x: { display: false },
              y: { display: false }
          }
      }
  });

  // Настройка графика проектов
  const projectsCtx = document.getElementById('projectsChart').getContext('2d');
  new Chart(projectsCtx, {
      type: 'line',
      data: {
          labels: projectLabels,
          datasets: [{
              label: 'Проекты',
              data: projectData,
              fill: true,
              borderColor: '#28a745',
              backgroundColor: 'rgba(40, 167, 69, 0.2)',
              tension: 0.4,
              pointRadius: 5,
              pointHoverRadius: 7,
          }]
      },
      options: {
          plugins: {
              legend: { display: false },
              tooltip: {
                  callbacks: {
                      label: function(context) {
                          return `Проекты: ${context.parsed.y}`;
                      }
                  }
              }
          },
          scales: {
              x: { display: false },
              y: { display: false }
          }
      }
  });

  // Настройка графика браузеров
  const browserCtx = document.getElementById('browserChart').getContext('2d');
  new Chart(browserCtx, {
      type: 'pie',
      data: {
          labels: browserLabels,
          datasets: [{
              data: browserData,
              backgroundColor: [
                  'rgba(255, 99, 132, 0.6)',
                  'rgba(54, 162, 235, 0.6)',
                  'rgba(255, 206, 86, 0.6)',
                  'rgba(75, 192, 192, 0.6)',
                  'rgba(153, 102, 255, 0.6)',
                  'rgba(255, 159, 64, 0.6)'
              ],
              borderColor: [
                  'rgba(255, 99, 132, 1)',
                  'rgba(54, 162, 235, 1)',
                  'rgba(255, 206, 86, 1)',
                  'rgba(75, 192, 192, 1)',
                  'rgba(153, 102, 255, 1)',
                  'rgba(255, 159, 64, 1)'
              ],
              borderWidth: 1
          }]
      },
      options: {
          plugins: {
              legend: { position: 'top' },
              tooltip: {
                  callbacks: {
                      label: function(context) {
                          const label = context.label || '';
                          const value = context.parsed;
                          return `${label}: ${value}`;
                      }
                  }
              }
          }
      }
  });
  /*]]>*/
</script>
</body>
</html>
