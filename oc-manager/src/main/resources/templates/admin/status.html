<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Статус Воркеров</title>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/@primer/css/dist/primer.css">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
          box-sizing: border-box;
      }

      body {
          margin: 0;
          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
          background-color: #f0f2f5;
          color: #24292e;
      }

      #wrapper {
          display: flex;
      }

            .navbar-icons a:hover {
               color: #d39e00;
           }

           .navbar-icons form button .fas {
               font-size: 24px;
               color: #dc3545;
               transition: color 0.3s;
           }

      #sidebar-wrapper {
          width: 60px;
          height: 100vh;
          background-color: #ffffff;
          border-right: none;
          transition: width 0.3s ease;
          position: fixed;
          display: flex;
          flex-direction: column;
          align-items: center;
          padding-top: 20px;
      }

      #sidebar-wrapper.expanded {
          width: 250px;
          align-items: flex-start;
          padding-left: 20px;
      }

      .sidebar-heading {
          text-align: center;
          margin-bottom: 30px;
      }

      .sidebar-heading i {
          font-size: 24px;
          color: #6f42c1;
      }

      .sidebar-heading .sidebar-text {
          margin-left: 10px;
          font-size: 18px;
          color: #6f42c1;
          display: none;
      }

      #sidebar-wrapper.expanded .sidebar-text {
          display: inline;
      }

      .list-group-item {
          padding: 15px 20px;
          text-decoration: none;
          color: #6c757d;
          display: flex;
          align-items: center;
          transition: background 0.3s, color 0.3s;
          border: none;

          border-radius: 8px;
          margin: 5px 10px;
          width: 100%;
          position: relative;
      }

      .list-group-item:hover {
          background-color: #e6e6e6;
          color: #6f42c1;
      }

      .list-group-item.active {
          background-color: #6f42c1;
          color: #ffffff;
          border: 1px solid #6f42c1;
      }

      .list-group-item i {
          margin-right: 10px;
          font-size: 18px;
          min-width: 20px;
          text-align: center;
      }

      #sidebar-wrapper .list-group-item {
          text-decoration: none;
      }


      #page-content-wrapper {
          margin-left: 60px;
          flex-grow: 1;
          transition: margin-left 0.2s ease;
      }

      #sidebar-wrapper.expanded + #page-content-wrapper {
          margin-left: 200px;
      }
       .navbar {
           display: flex;
           justify-content: center;
           align-items: center;
           padding: 10px 20px;
           background-color: #f0f2f5;
           border-bottom: none;
           box-shadow: none;
       }
       .navbar-icons {
           display: flex;
           align-items: center;
           gap: 15px;
       }

       .admin-info {
           display: flex;
           align-items: center;
           gap: 10px;
           margin-right: auto;
       }

       .admin-avatar {
           width: 40px;
           height: 40px;
           border-radius: 50%;

       }

       .admin-name {
           font-size: 16px;
           font-weight: 600;
           color: #24292e;
       }

       .navbar-icons a,
       .navbar-icons form button {
           font-size: 24px;
           cursor: pointer;
           transition: color 0.3s;
       }

       .navbar-icons a:hover,
       .navbar-icons form button:hover {
           color: #d39e00;
       }
        .navbar-icons form button .fas:hover {
                   color: #bd2130;
               }
      .navbar button {
          padding: 8px;
          background-color: #6c757d;
          border: none;
          color: #fff;
          cursor: pointer;
      }

      .navbar button:hover {
          background-color: #5a6268;
      }
       .chart-container {
           position: relative;
           width: 200px;
           height: 200px;
           margin: 20px;
       }
       .worker-card {
           display: flex;
           flex-direction: column;
           align-items: center;
           padding: 15px;
           border: 1px solid #ddd;
           border-radius: 8px;
           box-shadow: 0 2px 5px rgba(0,0,0,0.1);
           background-color: #fff;
       }
       .worker-name {
           margin-bottom: 10px;
           font-weight: bold;
           text-align: center;
       }
       .charts-row {
           display: flex;
           justify-content: center;
           flex-wrap: wrap;
       }
    </style>
</head>
<body>
<div id="wrapper">
    <div id="sidebar-wrapper">
        <div class="sidebar-heading">
            <i class="fas fa-chart-line"></i> <span class="sidebar-text"></span>
        </div>
        <a href="/admin/dashboard" class="list-group-item">
            <i class="fas fa-home"></i> <span class="sidebar-text"></span>
        </a>
        <a href="/admin/users" class="list-group-item">
            <i class="fas fa-users"></i> <span class="sidebar-text"></span>
        </a>
        <a href="/admin/projects_list" class="list-group-item">
            <i class="fas fa-folder-open"></i> <span class="sidebar-text"></span>
        </a>
        <a href="/admin/unbanRequests" class="list-group-item  active">
            <i class="fas fa-ban"></i> <span class="sidebar-text"> </span>
        </a>
        <a href="/admin/status" class="list-group-item">
            <i class="fas fa-tools"></i> <span class="sidebar-text"></span>
        </a>
    </div>

    <div id="page-content-wrapper">
        <div class="navbar">
            <div class="admin-info">
                <img th:src="${client.avatarUrl != null ? client.avatarUrl : '/noAvatar.png'}" alt="User Avatar" class="admin-avatar">
                <span class="admin-name" th:text="${client.username}"></span>
            </div>
            <div class="navbar-icons">
                <a href="/admin/notifications" title="Уведомления">
                    <i class="fas fa-bell"></i>
                </a>
                <form th:action="@{/logout}" th:method="POST">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <button type="submit" title="Выход" style="background: none; border: none; padding: 0;">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </form>
            </div>
        </div>
        <div class="main-container">
            <div class="container">
                <h1 class="text-center">Статус Воркеров</h1>
                <div class="charts-row" id="charts-row"></div>
            </div>
        </div>


<script>
    const chartsRow = document.getElementById('charts-row');
    const charts = {}; // Объект для хранения экземпляров диаграмм

    async function fetchWorkerData() {
        try {
            const response = await fetch('/admin/status/data');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            updateCharts(data);
        } catch (error) {
            console.error('Ошибка при получении данных воркеров:', error);
        }
    }

    function updateCharts(workers) {
        workers.forEach((worker, index) => {
            const existingCard = document.getElementById(`worker-card-${index}`);
            if (!existingCard) {
                // Создаём карточку воркера
                const card = document.createElement('div');
                card.classList.add('worker-card');
                card.id = `worker-card-${index}`;

                // Название воркера
                const workerName = document.createElement('div');
                workerName.classList.add('worker-name');
                workerName.textContent = worker.url;
                card.appendChild(workerName);

                // Контейнер для диаграммы CPU
                const cpuContainer = document.createElement('div');
                cpuContainer.classList.add('chart-container');
                const cpuCanvas = document.createElement('canvas');
                cpuCanvas.id = `cpu-chart-${index}`;
                cpuContainer.appendChild(cpuCanvas);
                card.appendChild(cpuContainer);

                // Контейнер для диаграммы памяти
                const memoryContainer = document.createElement('div');
                memoryContainer.classList.add('chart-container');
                const memoryCanvas = document.createElement('canvas');
                memoryCanvas.id = `memory-chart-${index}`;
                memoryContainer.appendChild(memoryCanvas);
                card.appendChild(memoryContainer);

                chartsRow.appendChild(card);

                // Создаём диаграммы CPU и памяти
                createCpuChart(cpuCanvas.id, worker);
                createMemoryChart(memoryCanvas.id, worker);
            } else {
                // Обновляем существующие диаграммы
                updateCpuChart(`cpu-chart-${index}`, worker);
                updateMemoryChart(`memory-chart-${index}`, worker);
            }
        });

        // Удаляем карточки для воркеров, которых больше нет
        const existingCards = Array.from(chartsRow.children);
        existingCards.forEach((card, index) => {
            if (index >= workers.length) {
                chartsRow.removeChild(card);
                delete charts[`cpu-chart-${index}`];
                delete charts[`memory-chart-${index}`];
            }
        });
    }

    function createCpuChart(canvasId, worker) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        const cpuUsage = worker.cpuUsage.toFixed(2);
        const cpuData = worker.available ? [0, 100] : [cpuUsage, 100 - cpuUsage];

        charts[canvasId] = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Использовано', 'Свободно'],
                datasets: [{
                    data: cpuData,
                    backgroundColor: worker.available ? ['rgba(75, 192, 192, 0.5)', '#e0e0e0'] :
                        ['rgba(255, 99, 132, 0.5)', '#e0e0e0'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: false,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed.toFixed(2);
                                return `${label}: ${value}%`;
                            }
                        }
                    }
                }
            }
        });
    }

    function updateCpuChart(canvasId, worker) {
        if (charts[canvasId]) {
            const cpuUsage = worker.cpuUsage.toFixed(2);
            const newData = worker.available ? [0, 100] : [cpuUsage, 100 - cpuUsage];
            charts[canvasId].data.datasets[0].data = newData;

            // Обновляем цвета в зависимости от состояния воркера
            if (worker.available) {
                charts[canvasId].data.datasets[0].backgroundColor = ['rgba(75, 192, 192, 0.5)', '#e0e0e0'];
            } else {
                charts[canvasId].data.datasets[0].backgroundColor = ['rgba(255, 99, 132, 0.5)', '#e0e0e0'];
            }

            charts[canvasId].update();
        }
    }

    function createMemoryChart(canvasId, worker) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        const memoryUsage = worker.memoryUsage.toFixed(2);
        const memoryLimit = 512; // Лимит памяти в MB, измените при необходимости
        const memoryData = worker.available ? [0, memoryLimit] : [memoryUsage, memoryLimit - memoryUsage];

        charts[canvasId] = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Использовано (MB)', 'Свободно (MB)'],
                datasets: [{
                    data: memoryData,
                    backgroundColor: worker.available ? ['rgba(75, 192, 192, 0.5)', '#e0e0e0'] :
                        ['rgba(255, 99, 132, 0.5)', '#e0e0e0'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: false,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed.toFixed(2);
                                return `${label}: ${value} MB`;
                            }
                        }
                    }
                }
            }
        });
    }

    function updateMemoryChart(canvasId, worker) {
        if (charts[canvasId]) {
            const memoryUsage = worker.memoryUsage.toFixed(2);
            const memoryLimit = 512; // Лимит памяти в MB, измените при необходимости
            const newData = worker.available ? [0, memoryLimit] : [memoryUsage, memoryLimit - memoryUsage];
            charts[canvasId].data.datasets[0].data = newData;

            // Обновляем цвета в зависимости от состояния воркера
            if (worker.available) {
                charts[canvasId].data.datasets[0].backgroundColor = ['rgba(75, 192, 192, 0.5)', '#e0e0e0'];
            } else {
                charts[canvasId].data.datasets[0].backgroundColor = ['rgba(255, 99, 132, 0.5)', '#e0e0e0'];
            }

            charts[canvasId].update();
        }
    }

    // Инициализация: получение данных и установка интервала обновления
    fetchWorkerData();
    setInterval(fetchWorkerData, 1000); // Обновление каждую секунду
</script>
</body>
</html>
