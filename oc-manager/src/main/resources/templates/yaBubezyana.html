const templates = {
"java": `public class Main {\n    public static void main(String[] args) {\n        System.out.println("Hello, Java!");\n    }\n}`,
"cpp": `#include <iostream>\nusing namespace std;\n\nint main() {\n    cout << "Hello, C++!" << endl;\n    return 0;\n}`,
    "python3": `print("Hello, Python!")`
    };

    // Инициализация глобальных переменных
    window.files = [];      // Массив для хранения файлов: {fileName, content}
    window.openFiles = {};  // Объект для хранения содержимого открытых файлов
    let editor;
    let models = {};        // Объект для хранения моделей для каждого языка

    // Добавление файла в массив файлов
    function addFile(fileName, content) {
    window.files.push({ fileName, content });
    console.log(`Файл ${fileName} добавлен в список.`);
    }

    // Добавление файла в контейнер файлов
    function addFileToContainer(fileName) {
    console.log("Добавляем файл:", fileName);
    const filesContainer = document.getElementById('files-container');

    if (!filesContainer) {
    console.error("Контейнер для файлов не найден!");
    return;
    }

    const fileElement = document.createElement('div');
    fileElement.classList.add('file-item-container');

    const fileNameSpan = document.createElement('span');
    fileNameSpan.textContent = fileName;
    fileNameSpan.classList.add('file-name');

    // Обработчик клика по файлу для его открытия
    fileElement.addEventListener('click', () => {
    openFile(fileName);  // Открываем файл в редакторе
    highlightActiveFile(fileElement);  // Подсветка активного файла
    });

    fileElement.appendChild(fileNameSpan);
    filesContainer.appendChild(fileElement);

    console.log(`Файл ${fileName} добавлен в контейнер.`);
    }

    // Открытие файла в редакторе
    function openFile(fileName) {
    const currentFileName = getCurrentFileName();

    // Сохраняем текущее содержимое открытого файла перед переключением
    if (currentFileName && window.openFiles[currentFileName]) {
    window.openFiles[currentFileName] = editor.getValue();
    console.log(`Содержимое файла ${currentFileName} сохранено перед переключением.`);
    }

    // Находим объект файла в массиве
    const fileObj = window.files.find(file => file.fileName === fileName);
    if (!fileObj) {
    console.error(`Файл ${fileName} не найден в списке.`);
    return;
    }

    if (fileObj.content) {
    // Если содержимое уже загружено, устанавливаем его в редактор
    editor.setValue(fileObj.content);
    console.log(`Содержимое файла ${fileName} установлено в редактор.`);
    } else {
    // Иначе, загружаем содержимое с сервера
    const projectId = window.projectId;  // Используем window.projectId
    fetch(`/projects/${projectId}/files/${encodeURIComponent(fileName)}`)
    .then(response => {
    if (!response.ok) {
    throw new Error(`Ошибка при загрузке файла: ${response.statusText}`);
    }
    return response.text();
    })
    .then(content => {
    editor.setValue(content);
    fileObj.content = content;
    window.openFiles[fileName] = content;
    console.log(`Файл ${fileName} загружен с сервера и установлен в редактор.`);
    })
    .catch(error => {
    console.error('Ошибка при загрузке файла:', error);
    showErrorMessage(`Ошибка при загрузке файла ${fileName}: ${error.message}`);
    });
    }

    highlightActiveFileByName(fileName);
    }

    // Подсветка активного файла
    function highlightActiveFile(selectedFileElement) {
    const fileItems = document.querySelectorAll('.file-item-container');
    fileItems.forEach(item => item.classList.remove('active'));  // Снимаем выделение

    selectedFileElement.classList.add('active');  // Выделяем активный файл
    console.log(`Файл ${selectedFileElement.querySelector('.file-name').textContent} активирован.`);
    }

    // Подсветка активного файла по имени
    function highlightActiveFileByName(fileName) {
    const fileItems = document.querySelectorAll('.file-item-container');
    fileItems.forEach(item => {
    const itemName = item.querySelector('.file-name').textContent;
    if (itemName === fileName) {
    item.classList.add('active');
    } else {
    item.classList.remove('active');
    }
    });
    }

    // Получение текущего имени файла
    function getCurrentFileName() {
    const activeFile = document.querySelector('.file-item-container.active .file-name');
    return activeFile ? activeFile.textContent : null;
    }

    // Инициализация Monaco Editor
    require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.28.1/min/vs' }});
    require(['vs/editor/editor.main'], function() {
    // Создаём модели для каждого языка с шаблонами
    models['java'] = monaco.editor.createModel(templates['java'], 'java');
    models['cpp'] = monaco.editor.createModel(templates['cpp'], 'cpp');
    models['python3'] = monaco.editor.createModel(templates['python3'], 'python');

    // Инициализация редактора с моделью Java по умолчанию
    editor = monaco.editor.create(document.getElementById('editor-container'), {
    model: models['java'],
    theme: 'vs-dark'
    });

    console.log("Monaco Editor инициализирован с моделью Java.");
    });

    // Обработчик для смены языка
    function setLanguage(language) {
    editor.pushUndoStop();  // Останавливаем запись в историю
    const currentModel = models[language];
    if (currentModel) {
    editor.setModel(currentModel);  // Переключаем модель
    console.log(`Язык программирования изменён на ${language}.`);
    } else {
    console.error(`Модель для языка ${language} не найдена.`);
    }
    editor.pushUndoStop();  // Включаем запись в историю
    }

    // Загрузка файла в редактор и добавление его в контейнер файлов
    function uploadFile() {
    console.log("Начало загрузки файла");
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.txt,.java,.py,.cpp';

    input.onchange = e => {
    const file = e.target.files[0];
    if (!file) {
    console.log("Файл не выбран.");
    return;
    }

    const reader = new FileReader();

    reader.onload = event => {
    const content = event.target.result;
    const fileName = file.name;

    console.log(`Файл выбран: ${fileName}`);

    // Проверка, существует ли уже файл с таким именем
    const existingFile = window.files.find(file => file.fileName === fileName);
    if (existingFile) {
    const overwrite = confirm(`Файл "${fileName}" уже существует. Перезаписать?`);
    if (!overwrite) {
    console.log(`Файл ${fileName} не был перезаписан.`);
    return;
    }
    existingFile.content = content;
    window.openFiles[fileName] = content;
    console.log(`Файл ${fileName} обновлён.`);
    // Если файл активен, обновить содержимое редактора
    const activeFileName = getCurrentFileName();
    if (activeFileName === fileName) {
    editor.setValue(content);
    console.log(`Содержимое файла ${fileName} обновлено в редакторе.`);
    }
    return;
    }

    // Добавляем файл в массив
    addFile(fileName, content);

    // Устанавливаем содержимое файла в редактор
    editor.setValue(content);
    console.log(`Содержимое файла ${fileName} установлено в редактор.`);

    // Отображаем файл в контейнере файлов
    addFileToContainer(fileName);

    // Скрываем сообщение об отсутствии файлов, если добавлен файл
    document.getElementById('no-files-message').style.display = 'none';
    };

    reader.onerror = () => {
    console.error("Ошибка при чтении файла.");
    showErrorMessage("Ошибка при чтении файла.");
    };

    reader.readAsText(file);
    };
    input.click();
    }

    // Скачивание содержимого текущего файла
    function downloadFile() {
    const currentFileName = getCurrentFileName();
    if (!currentFileName) {
    alert("Нет открытого файла для скачивания.");
    console.log("Нет открытого файла для скачивания.");
    return;
    }
    const fileObj = window.files.find(file => file.fileName === currentFileName);
    if (!fileObj || !fileObj.content) {
    alert("Содержимое файла недоступно.");
    console.log(`Содержимое файла ${currentFileName} недоступно.`);
    return;
    }
    const content = fileObj.content;
    const blob = new Blob([content], { type: 'text/plain' });

    const link = document.createElement('a');
    link.download = currentFileName;
    link.href = window.URL.createObjectURL(blob);
    link.click();

    console.log(`Файл ${currentFileName} скачан.`);
    }

    // Функция для сохранения проекта
    async function saveProject() {
    const language = document.getElementById('languageSelect').value;

    // Получаем содержимое текущего файла и обновляем его в массиве файлов
    const currentFileName = getCurrentFileName();
    if (currentFileName) {
    const fileObj = window.files.find(file => file.fileName === currentFileName);
    if (fileObj) {
    fileObj.content = editor.getValue();
    window.openFiles[currentFileName] = fileObj.content;
    console.log(`Содержимое файла ${currentFileName} обновлено перед сохранением.`);
    }
    }

    // Получаем CSRF-токен и заголовок из метатегов
    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    const projectId = window.projectId;
    console.log("Значение projectId перед сохранением:", projectId);

    if (!projectId) {
    alert("Не удалось определить идентификатор проекта.");
    console.log("Не удалось определить идентификатор проекта.");
    return;
    }

    try {
    // Создаем FormData для отправки файлов
    const formData = new FormData();

    // Добавляем каждый файл в FormData
    window.files.forEach(file => {
    if (file.content) {
    const blob = new Blob([file.content], { type: 'text/plain' });
    formData.append('files', blob, file.fileName);
    console.log(`Файл ${file.fileName} добавлен в FormData.`);
    } else {
    console.warn(`Содержимое файла ${file.fileName} отсутствует и не будет отправлено.`);
    }
    });

    // Если нужен путь, добавьте его
    formData.append('path', ''); // Укажите путь, если требуется

    const response = await fetch(`/projects/${projectId}/save`, {
    method: 'POST',
    headers: {
    [csrfHeader]: csrfToken
    },
    body: formData
    });

    if (response.ok) {
    // Отобразить сообщение об успешном сохранении
    showSuccessMessage("Ваш проект успешно сохранён");
    console.log("Проект успешно сохранён.");
    } else {
    const errorText = await response.text();
    showErrorMessage(`Ошибка при сохранении проекта: ${errorText}`);
    console.error(`Ошибка при сохранении проекта: ${errorText}`);
    }
    } catch (error) {
    showErrorMessage(`Ошибка: ${error.message}`);
    console.error(`Ошибка: ${error.message}`);
    }
    }

    // Отправка всех файлов на сервер
    async function submitCode() {
    const language = document.getElementById('languageSelect').value;

    // Обновляем содержимое текущего файла перед отправкой
    const currentFileName = getCurrentFileName();
    if (currentFileName) {
    const fileObj = window.files.find(file => file.fileName === currentFileName);
    if (fileObj) {
    fileObj.content = editor.getValue();
    window.openFiles[currentFileName] = fileObj.content;
    console.log(`Содержимое файла ${currentFileName} обновлено перед отправкой на компиляцию.`);
    }
    }

    // Получаем CSRF-токен и заголовок из метатегов
    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    const projectId = window.projectId;
    console.log("Значение projectId перед компиляцией:", projectId);

    if (!projectId) {
    alert("Не удалось определить идентификатор проекта.");
    console.log("Не удалось определить идентификатор проекта.");
    return;
    }

    try {
    const response = await fetch(`/projects/${projectId}/compile`, { // Исправленный URL
    method: 'POST',
    headers: {
    'Content-Type': 'application/json',
    [csrfHeader]: csrfToken  // Добавляем CSRF-токен в заголовок
    },
    body: JSON.stringify({
    files: window.files.map(file => ({
    fileName: file.fileName,
    content: file.content
    })),
    language: language
    })
    });

    if (!response.ok) {
    const errorText = await response.text();
    throw new Error(`Ошибка компиляции: ${errorText}`);
    }

    const result = await response.text();
    document.getElementById('output').textContent = result || "No errors, code executed successfully!";
    console.log("Компиляция успешно выполнена.");
    } catch (error) {
    document.getElementById('output').textContent = `Error: ${error.message}`;
    console.error(`Ошибка при компиляции: ${error.message}`);
    }
    }

    // Обновляем содержимое файла в массиве файлов
    function updateFileContent(fileName, newContent) {
    const fileObj = window.files.find(file => file.fileName === fileName);
    if (fileObj) {
    fileObj.content = newContent;
    window.openFiles[fileName] = newContent;  // Обновляем в массиве открытых файлов
    console.log(`Содержимое файла ${fileName} обновлено.`);
    } else {
    console.error(`Файл ${fileName} не найден в списке.`);
    }
    }

    // Функция для отображения успешного сообщения
    function showSuccessMessage(message) {
    const messageContainer = document.getElementById('message-container');
    messageContainer.innerHTML = `<div class="alert alert-success">${message}</div>`;
    setTimeout(() => {
    messageContainer.innerHTML = '';
    }, 5000); // Сообщение исчезнет через 5 секунд
    console.log(`Сообщение об успешном действии: ${message}`);
    }

    // Функция для отображения ошибки
    function showErrorMessage(message) {
    const messageContainer = document.getElementById('message-container');
    messageContainer.innerHTML = `<div class="alert alert-danger">${message}</div>`;
    setTimeout(() => {
    messageContainer.innerHTML = '';
    }, 5000);
    console.error(`Сообщение об ошибке: ${message}`);
    }
